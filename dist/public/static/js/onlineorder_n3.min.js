$(document).ready(function(){online.onlineOrderPage();online.operating()});var online={onlineOrderPage:function(){var o=$("#txtSearch").val().trim(),t="",i="",u=-1,r="",f=-1,e=-1,n=1;if($("#chosen li.active").each(function(){var s=$(this).data("name"),o;switch(s){case"deliverytype":u=$(this).attr("data-id");break;case"deliverystatus":f=$(this).attr("data-id");break;case"paymentstatus":e=$(this).attr("data-id");break;case"payType":o=$(this).attr("data-id");r=o==1?"\u5fae\u4fe1\u652f\u4ed8":"\u50a8\u503c\u5361";break;case"adddateFilter":o=$(this).attr("data-id");o==4?n=-1:o==3?(n=3,t=$("#startDate").val(),i=$("#endDate").val()):n=o}}),!getIntervalMonth(t,i))return layer.msg("\u65e5\u671f\u641c\u7d22\u6700\u5927\u8303\u56f4\u4e3a6\u4e2a\u6708"),!1;$.get("/OnlineOrder/Total/",{seachStr:o,beginDate:t,endDate:i,shipping_methods:u,payMode:r,goodsState:f,payState:e,numberDay:n},function(s){var h=Math.ceil(s/12);laypage({cont:$("#pageGro"),pages:h,skin:"molv",skip:!0,first:"\u9996\u9875",last:"\u5c3e\u9875",prev:"\u4e0a\u4e00\u9875",next:"\u4e0b\u4e00\u9875",jump:function(s){online.getpageList(o,s.curr,t,i,u,r,f,e,n)}})})},getpageList:function(n,t,i,r,u,f,e,o,s){var h=openLoadingIng();$.getJson("/OnlineOrder/GetMoveOrderList",{seachStr:n,pageIndex:t,pageSize:12,beginDate:i,endDate:r,shipping_methods:u,payMode:f,goodsState:e,payState:o,numberDay:s},function(n){var i,t,r,f,e,u,o,s,c,l,a,v;if(commonCloseLoading(h),i="",n!=null&&n!=""){for(t=0;t<n.length;t++)r=n[t].sv_delivery_status,f="",r==0?r="\u5f85\u4ed8\u6b3e":r==1?(r="\u5f85\u53d1\u8d27",f='<button class="btn confirmtakeway" id="btnProcessOrder" data-id="'+n[t].sv_move_order_id+'" data-status="1">\u786e\u8ba4\u53d1\u8d27<\/button>'):r==2?(r="\u5df2\u53d1\u8d27",f='<button class="btn confirmtakeway confirmtakeway2" id="btnProcessOrder" data-id="'+n[t].sv_move_order_id+'" data-status="2">\u786e\u8ba4\u6536\u8d27<\/button>'):r==3?r="\u5df2\u6536\u8d27":r==4?r="\u9000\u8d27":r==5&&(r="\u4ea4\u6613\u5b8c\u6210"),e=n[t].sv_order_remarks,e.length>6&&(e=e.substring(0,6)+".."),u="",n[t].order_state==0?u="\u5f85\u4ed8\u6b3e":n[t].order_state==1?u="\u5df2\u4ed8\u6b3e":n[t].order_state==2?u="\u4ea4\u6613\u5df2\u5173\u95ed":n[t].order_state==3&&(u="\u4ea4\u6613\u5df2\u5173\u95ed"),n[t].order_state==1&&(u=r),o=n[t].sv_shipping_methods==0?"\u5230\u5e97\u81ea\u63d0":"\u9001\u8d27\u4e0a\u95e8",s=n[t].sv_finish_time=="0001-01-01T00:00:00"?"":new Date(n[t].sv_finish_time).Format("yy-MM-dd hh:mm:ss"),i+='<li data-orderId="'+n[t].sv_move_order_id+'">',i+='<div class="takeawayordermain">',i+='<div class="style-title">',i+='<i class="roud"><\/i>',i+="<span>"+o+"<\/span>",i+='<span class="ordertime">'+s+"<\/span>",i+='<button class="btn fr removethis icon-trash" data-orderId="'+n[t].sv_move_order_id+'"><\/button>',i+="<\/div>",i+='<div class="style-title">',n[t].sv_shipping_methods==0?(c=n[t].sv_contact_name!=null&&n[t].sv_contact_name!=""?n[t].sv_contact_name:"",l=n[t].sv_contact_phone!=null&&n[t].sv_contact_phone!=""?n[t].sv_contact_phone:"",i+="<span>"+c+"<\/span>",i+='<span class="phonenumber">'+l+"<\/span>"):(a=n[t].sv_receipt_name!=null&&n[t].sv_receipt_name!=""?n[t].sv_receipt_name:"",v=n[t].sv_receipt_phone!=null&&n[t].sv_receipt_phone!=""?n[t].sv_receipt_phone:"",i+="<span>"+a+"<\/span>",i+='<span class="phonenumber">'+v+"<\/span>"),i+='<span class="phonenumber colorff fr">'+u+"<\/span>",i+="<\/div>",i+='<div class="useraddress">',i+=n[t].sv_shipping_methods==1?"<span>"+n[t].getShopAddress+"<\/span>":"<span> <\/span>",i+="<\/div>",i+='<div class="useraddress">'+f+"",i+='<a class="fr" href="javascript:void(0);">\u8be6\u60c5>><\/a>',i+="<\/div>",i+="<\/div>",i+="<\/li>";$("#listhtml").html(i)}else $("#listhtml").html('<li style="width:100%;line-height:100px;" class="text-center"><img src="../skin_N3/images/sad.png"><i class="padd0">\u6682\u65e0\u7ebf\u4e0a\u8ba2\u5355\u6570\u636e<\/i><\/li>')})},operating:function(){function i(n){$.getJson("/OnlineOrder/MoveOrdeInfo",{orderId:n},function(n){var l,a,f,o,rt,c;if(n&&n.orderList){var t=n.orderList,w=n.shopInfo,b=new Date(t.sv_order_adddate).Format("yy-MM-dd hh:mm:ss"),k=new Date(t.sv_delivery_time).Format("yyyy-MM-dd"),d=t.sv_shipping_methods==0?"\u5230\u5e97\u81ea\u63d0":"\u9001\u8d27\u4e0a\u95e8",g=t.order_payment==""?"\u672a\u652f\u4ed8":t.order_payment,s="";t.order_state==0?s="\u5f85\u4ed8\u6b3e":t.order_state==1?s="\u5df2\u4ed8\u6b3e":t.order_state==2?s="\u4ea4\u6613\u5df2\u5173\u95ed":t.order_state==3&&(s="\u4ea4\u6613\u5df2\u5173\u95ed");var nt=w.sv_us_name.substr(0,12),tt=t.sv_receipt_name!=null&&t.sv_receipt_name!=""?t.sv_receipt_name:"",it=t.sv_receipt_phone!=null&&t.sv_receipt_phone!=""?t.sv_receipt_phone:"";if($("#activeInfo").html(""),$("#sv_delivery_status").hide(),$("#wt_nober").text(t.sv_order_number),$("#wt_datetime").text(b),$("#wt_datetime2").text(k),$("#meituanDeliveryMethod").text(d),$("#sv_payment_type").text(g),$("#sv_shop_payment_status").text(s),$("#ThisShopName").text(nt),$("#sv_order_receivable").text("\u00a5"+parseFloat(t.order_receivable||0).toFixed(2)),$("#sv_order_actual_money").text("\u00a5"+parseFloat(t.sv_price_total||0).toFixed(2)),t.sv_shipping_methods==1?$("#meituanfreight").text(parseFloat(t.sv_prduct_freight).toFixed(2)):$("#freight_display_none").hide(0),$("#memberDiscount").hide(0),t.sv_order_remarks?($("#sv_order_remarks").show(0),$("#sv_order_remarks_info").text(t.sv_order_remarks)):($("#sv_order_remarks").hide(0),$("#sv_order_remarks_info").text("")),t.sv_shipping_methods==0?(l=t.sv_contact_name!=null&&t.sv_contact_name!=""?t.sv_contact_name:"",a=t.sv_contact_phone!=null&&t.sv_contact_phone!=""?t.sv_contact_phone:"",$("#address_info").text("\u63d0\u8d27\u4fe1\u606f\uff1a"),$("#sv_receipt_name").text(l),$("#sv_receipt_phone").text(a),$("#sv_receipt_address").text("")):($("#address_info").text("\u6536\u8d27\u5730\u5740\uff1a"),$("#sv_receipt_name").text(tt),$("#sv_receipt_phone").text(it),$("#sv_receipt_address").text(t.getShopAddress)),$("#meituanDeliveryMethod").text()=="\u9001\u8d27\u4e0a\u95e8"&&u(),t.member_id>0&&$.get("/Ajaxdata/GetUserModel?id="+t.member_id,function(n){$("#sv_member_info").text(n.sv_mr_name+"("+n.sv_mr_cardno+","+n.sv_mr_mobile+")")}),t!=null&&t!=""){var i=t.productList,v="",e="",y=0,p="//decerp.cc",h="//res.decerp.cc";for(f=0;f<i.length;f++)o=i[f].product_name,o!=null&&o!=""&&o.length>15&&(o=i[f].product_name.substring(0,20)+"..."),rt=i[f].sv_p_images2!=null&&i[f].sv_p_images2!=""?i[f].sv_p_images2:"/images/omg1.jpg",e+='<li data-pid="'+i[f].sv_order_product_id+'">',v=i[f].sv_p_images2?i[f].sv_p_images2.indexOf(p)>-1?i[f].sv_p_images2.replace(p,h):i[f].sv_p_images2.indexOf(h)>-1?i[f].sv_p_images2:h+i[f].sv_p_images2:"/images/omg1.jpg",e+='<div class="imgbox"><img class="" src="'+v+'" /><\/div><div class="foodlistinfo">',e+='<div class="sharename-number"><span>'+o+"<\/span><\/div>",c=parseFloat(i[f].sv_p_weight+i[f].sv_product_num),e+='<div class="sharename-number"><i class="moneyred">\u00a5'+i[f].sv_product_unitprice+"<\/i>",e+='<i class="pad10">x'+c+"<\/i><\/div><\/div><\/li>",y+=c*i[f].product_price-i[f].sv_product_total;$("#foodlist").html(e);t.sv_order_remarks?$("#sv_order_remarks_text2").text("\u7559\u8a00\uff1a"+t.sv_order_remarks):$("#sv_order_remarks_text2").text("");$("#discountedPrice").text(parseFloat(y||0).toFixed(2));i.length>2?($("#productNumber").text(i.length-2),$(".morenumber").show()):$(".morenumber").hide()}$("#meituancaution").hide(0);$("#memberDiscount").show(0);$("#takeawayorderinfobox").show(300).animate({right:0},350);$("#takeawayorderinfobox button.print_takeawayorder").unbind("click").on("click",function(){$.getJSON("/system/Getprint",function(n){n&&r(t,n)})})}})}function r(n,t){var r={prdata:""},u,e,o,i,f;if(r.prdata=n,r.prdata.user=t,u=r.prdata,u&&u.prlist&&u.prlist.length>0)for(i=0;i<u.prlist.length;i++)e=u.prlist[i].sv_pricing_method==1?u.prlist[i].sv_p_weight:u.prlist[i].product_num,u.prlist[i].product_num=e;if(o=0,o=r.prdata.order_discount<1&&r.prdata.order_receivable>0&&r.prdata.order_discount>0?(r.prdata.order_receivable/r.prdata.order_discount).toFixed(2):r.prdata.sv_order_total_money,n.order_running_id=n.sv_order_number,n.sv_order_total_money=n.order_receivable,n.order_datetime=n.sv_order_adddate,n.sv_contact_name=n.sv_receipt_name,n.sv_contact_address=n.sv_receipt_address,n.sv_contact_phone=n.sv_receipt_phone,n.productList&&n.productList.length>0)for(n.prlist=[],i=0;i<n.productList.length;i++)f=n.productList[i],n.prlist.push({product_name:f.product_name,product_price:f.product_price,product_num:f.sv_product_num,product_total:f.sv_product_total,product_single_memberprice:f.sv_product_unitprice});n.user={sv_mr_cardno:n.sv_contact_phone,sv_mr_name:n.sv_contact_name,sv_mw_availableamount:0};pushprintData(JSON.stringify(n),JSON.stringify(t),0,0,null,null,!1,"\u7ebf\u4e0a\u5546\u57ce\u8ba2\u5355-\u8865")}function u(){$.getJson("/OnlineOrder/Address",{orderNum:$("#wt_nober").text()},function(n){n!=null&&n!=""&&($("#sv_receipt_name").text(n.sv_receipt_name),$("#sv_receipt_phone").text(n.sv_receipt_phone),$("#sv_receipt_address").text(n.pcdAddress))})}var n="",t;$(document).unbind("click","#deliverytype>li,#deliverystatus>li,#paymentstatus>li,#payType>li,#adddateFilter>li").on("click","#deliverytype>li,#deliverystatus>li,#paymentstatus>li,#payType>li,#adddateFilter>li",function(){var t=$(this).hasClass("on"),i=$(this).hasClass("active"),r=$(this).find("input").length;t||(i?$(this).data("id")!=-1&&($(this).removeClass("active"),$('#chosen>li[data-name="'+$(this).data("name")+'"').remove(),$("[data-id='0'][data-name='"+$(this).data("name")+"']").addClass("active")):($("#chosen").show(0),$(this).addClass("active").siblings("li").removeClass("active"),r==0&&($(this).data("name")=="adddateFilter"&&($("#startDate").val(""),$("#endDate").val("")),$('#chosen>li[data-name="'+$(this).data("name")+'"').remove(),n=$(this).clone(!0),n.appendTo("#chosen"))))});$("#begindate").datetimepicker({language:"zh",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,endDate:new Date,pickerPosition:"bottom-left",format:"yyyy/mm/dd 00:00:00"}).on("change",function(){var n=$("#startDate").val();$("#enddate").datetimepicker("setStartDate",n);$("#adddateFilter li").removeClass("active");$("#chosen").find("[data-name='adddateFilter']").remove();$("#startDate").val()!=""&&$("#endDate").val()!=""?$("#chosen").append('<li class="select active" data-id="3" data-name="adddateFilter" data-querydate="'+$("#startDate").val()+"-"+$("#endDate").val()+'">'+$("#startDate").val()+"-"+$("#endDate").val()+"<\/li>"):$("#startDate").val()==""?$("#chosen").append('<li class="select active" data-id="3" data-name="adddateFilter" data-querydate="\u4e0d\u9650-'+$("#endDate").val()+'">\u4e0d\u9650-'+$("#endDate").val()+"<\/li>"):$("#endDate").val()==""&&$("#chosen").append('<li class="select active" data-id="3" data-name="adddateFilter" data-querydate="'+$("#startDate").val()+'-\u81f3\u4eca">'+$("#startDate").val()+"-\u81f3\u4eca<\/li>");$("#begindate").datetimepicker("hide")});$("#enddate").datetimepicker({language:"zh",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,startDate:$("#startDate").val(),endDate:new Date,pickerPosition:"bottom-left",format:"yyyy/mm/dd 23:59:59"}).on("change",function(){var n=$("#endDate").val();$("#begindate").datetimepicker("setReturnDate",n);$("#adddateFilter li").removeClass("active");$("#chosen").find("[data-name='adddateFilter']").remove();$("#startDate").val()!=""&&$("#endDate").val()!=""?$("#chosen").append('<li class="active" data-id="3" data-name="adddateFilter" data-querydate="'+$("#startDate").val()+"-"+$("#endDate").val()+'">'+$("#startDate").val()+"-"+$("#endDate").val()+"<\/li>"):$("#startDate").val()==""?$("#chosen").append('<li class="active" data-id="3" data-name="adddateFilter" data-querydate="\u4e0d\u9650-'+$("#endDate").val()+'">\u4e0d\u9650-'+$("#endDate").val()+"<\/li>"):$("#endDate").val()==""&&$("#chosen").append('<li class="active" data-id="3" data-name="adddateFilter" data-querydate="'+$("#startDate").val()+'-\u81f3\u4eca">'+$("#startDate").val()+"-\u81f3\u4eca<\/li>");$("#enddate").datetimepicker("hide")});$(document).on("click","#chosen>li.active",function(){$(this).remove();$("[data-name='"+$(this).data("name")+"']").removeClass("active");$("[data-id='-1'][data-name='"+$(this).data("name")+"']").addClass("active");$("#chosen>li").length==1&&$("#chosen").hide(0)});$(document).unbind("click","#listhtml>li").on("click","#listhtml>li",function(){var n=$(this).data("orderid");i(n)});$(".returnbtn").click(function(){$("#takeawayorderinfobox").animate({right:-530},350).hide(300);$("#reservationOrderinfobox").animate({right:-530},350).hide(300)});t=$(window).height();$("#foodlistbox").height(t-535);$(".morenumber").click(function(){$("#foodlist>li").fadeIn(150);$("#productNumber").text("0")});$(document).unbind("click","#btnProcessOrder").on("click","#btnProcessOrder",function(){var n=$(this).data("status")==1?0:1;return $.postJson("/OnlineOrder/ProcessOrder",{orderId:$(this).data("id"),type:n},function(n){n?(online.onlineOrderPage(),layer.msg("\u8ba2\u5355\u5904\u7406\u6210\u529f",{icon:1,time:800})):layer.msg("\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u540e\u518d\u8bd5\uff01")}),!1});$(document).unbind("click","#listhtml .removethis").on("click","#listhtml .removethis",function(){var n=$(this).attr("data-orderId");return $.postAsyncJson("/OnlineOrder/MerchantDeleted",{orderId:n},function(n){n?(n.succeed&&online.onlineOrderPage(),layer.msg(n.errmsg)):layer.msg("\u64cd\u4f5c\u5931\u8d25\uff01")}),!1});$("#query_like_btn,#query_like_btn2").click(function(){online.onlineOrderPage()});$("#txtSearch").keypress(function(n){n.keyCode==13&&online.onlineOrderPage()});$("#exportsalesreport").click(function(){var o=$("#txtSearch").val().trim(),i="",r="",u=-1,t="",f=-1,e=-1,n=1;$("#chosen li.active").each(function(){var s=$(this).data("name"),o;switch(s){case"deliverytype":u=$(this).attr("data-id");break;case"deliverystatus":f=$(this).attr("data-id");break;case"paymentstatus":e=$(this).attr("data-id");break;case"payType":o=$(this).attr("data-id");t=o==1?"\u5fae\u4fe1\u652f\u4ed8":"\u50a8\u503c\u5361";break;case"adddateFilter":o=$(this).attr("data-id");o==4?n=-1:o==3?(n=3,i=$("#startDate").val(),r=$("#endDate").val()):n=o}});$.getJSON("/OnlineOrder/ExportData",{beginDate:i,endDate:r,shipping_methods:u,payMode:t,goodsState:f,payState:e,numberDay:n},function(n){if(n==-2)layer.msg("\u4f60\u6ca1\u6709\u8be5\u64cd\u4f5c\u6743\u9650\uff01");else if(n!=0)if(typeof Cef!="undefined")Cef.Download(n);else if(decerpbrowser&&decerpbrowser.versions&&decerpbrowser.versions.android)try{cordova.plugins.barcodeScanner.dwonloadexcel(function(){},function(n){alert("\u6570\u636e\u5bfc\u51fa\u5931\u8d25: "+n)},{myPrintData:n})}catch(t){alert("\u6570\u636e\u5bfc\u51fa\u5931\u8d25: "+t.message)}else location.href=n;else layer.msg("\u6570\u636e\u5bfc\u51fa\u5931\u8d25!")})})}};